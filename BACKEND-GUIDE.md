# üîß Gu√≠a Completa del Backend - Task Manager App

## üìã √çndice

1. [Arquitectura General](#arquitectura-general)
2. [Estructura de Archivos](#estructura-de-archivos)
3. [Modelos de Datos](#modelos-de-datos)
4. [Sistema de Autenticaci√≥n](#sistema-de-autenticaci√≥n)
5. [API Routes y Endpoints](#api-routes-y-endpoints)
6. [Middleware](#middleware)
7. [Validaciones](#validaciones)
8. [Flujo de Datos](#flujo-de-datos)
9. [Manejo de Errores](#manejo-de-errores)

---

## üèóÔ∏è Arquitectura General

### Tecnolog√≠as Utilizadas

- **Express.js**: Framework web para Node.js
- **MongoDB**: Base de datos NoSQL
- **Mongoose**: ODM (Object Document Mapper) para MongoDB
- **JWT**: JSON Web Tokens para autenticaci√≥n
- **bcryptjs**: Para encriptar contrase√±as
- **TypeScript**: Para tipado est√°tico

### Patr√≥n MVC Simplificado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Routes      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Controllers   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ     Models      ‚îÇ
‚îÇ  (Rutas API)    ‚îÇ    ‚îÇ  (L√≥gica de     ‚îÇ    ‚îÇ (Esquemas DB)   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ   Negocio)      ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚ñ≤                       ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Middleware    ‚îÇ    ‚îÇ   Responses     ‚îÇ    ‚îÇ    MongoDB      ‚îÇ
‚îÇ (Autenticaci√≥n) ‚îÇ    ‚îÇ    (JSON)       ‚îÇ    ‚îÇ   (Documentos)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ Estructura de Archivos

```
server/
‚îú‚îÄ‚îÄ index.ts              # üöÄ Servidor principal
‚îú‚îÄ‚îÄ models/               # üìä Modelos de datos
‚îÇ   ‚îú‚îÄ‚îÄ User.ts          # üë§ Modelo de Usuario
‚îÇ   ‚îî‚îÄ‚îÄ Task.ts          # üìã Modelo de Tarea
‚îú‚îÄ‚îÄ routes/              # üõ§Ô∏è Rutas de la API
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts          # üîê Rutas de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ tasks.ts         # üìù Rutas de tareas
‚îÇ   ‚îî‚îÄ‚îÄ users.ts         # üë• Rutas de usuarios
‚îú‚îÄ‚îÄ middleware/          # ‚öôÔ∏è Middleware personalizado
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts          # üîí Middleware de autenticaci√≥n
‚îî‚îÄ‚îÄ controllers/         # üéÆ Controladores (futuro)
```

---

## üìä Modelos de Datos

### üë§ Modelo Usuario (User.ts)

```typescript
interface IUser {
  email: string; // Email √∫nico del usuario
  password: string; // Contrase√±a encriptada
  name: string; // Nombre completo
  avatar?: string; // URL del avatar (opcional)
  role: "admin" | "user"; // Rol del usuario
}
```

**Caracter√≠sticas Importantes:**

- **Email √∫nico**: Previene duplicados con √≠ndice √∫nico
- **Contrase√±a encriptada**: Usa bcryptjs con 12 rounds de salt
- **Validaciones**: Email v√°lido, contrase√±a m√≠nimo 6 caracteres
- **Timestamps**: Autom√°ticos (createdAt, updatedAt)

### üìã Modelo Tarea (Task.ts)

```typescript
interface ITask {
  title: string; // T√≠tulo de la tarea
  description?: string; // Descripci√≥n opcional
  status: "todo" | "in-progress" | "done"; // Estado de la tarea
  priority: "low" | "medium" | "high"; // Prioridad
  assignee?: ObjectId; // Usuario asignado (opcional)
  creator: ObjectId; // Usuario creador (requerido)
  subtasks: ISubtask[]; // Array de subtareas
  dueDate?: Date; // Fecha l√≠mite (opcional)
  tags: string[]; // Etiquetas
}

interface ISubtask {
  title: string; // T√≠tulo de la subtarea
  completed: boolean; // Estado de completado
  createdAt: Date; // Fecha de creaci√≥n
}
```

**Validaciones Especiales:**

- ‚úÖ **Regla de Subtareas**: Una tarea NO puede marcarse como 'done' si tiene subtareas incompletas
- üîó **Referencias**: assignee y creator referencian al modelo User
- üìè **L√≠mites**: T√≠tulo m√°ximo 200 caracteres, descripci√≥n 1000
- üè∑Ô∏è **Tags**: M√°ximo 30 caracteres cada uno

---

## üîê Sistema de Autenticaci√≥n

### Flujo de Registro

```
1. Usuario env√≠a datos ‚îÄ‚îÄ‚îÄ‚ñ∂ 2. Validar email √∫nico
                          ‚ñº
6. Retornar JWT + datos ‚óÄ‚îÄ 3. Encriptar contrase√±a
                          ‚ñº
                          4. Guardar en DB
                          ‚ñº
                          5. Generar JWT token
```

### Flujo de Login

```
1. Usuario env√≠a credenciales ‚îÄ‚îÄ‚îÄ‚ñ∂ 2. Buscar por email
                                 ‚ñº
5. Retornar JWT + datos ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3. Comparar contrase√±as
                                 ‚ñº
                                 4. Generar JWT token
```

### JWT (JSON Web Tokens)

```typescript
// Payload del token
{
  userId: "string",      // ID del usuario
  email: "string",       // Email del usuario
  iat: number,           // Fecha de creaci√≥n
  exp: number            // Fecha de expiraci√≥n (7 d√≠as)
}
```

---

## üõ§Ô∏è API Routes y Endpoints

### üîê Autenticaci√≥n (`/api/auth`)

```
POST /api/auth/register  # Registrar nuevo usuario
POST /api/auth/login     # Iniciar sesi√≥n
GET  /api/auth/me        # Obtener perfil actual
```

### üìù Tareas (`/api/tasks`)

```
GET    /api/tasks              # Obtener todas las tareas
POST   /api/tasks              # Crear nueva tarea
GET    /api/tasks/:id          # Obtener tarea espec√≠fica
PUT    /api/tasks/:id          # Actualizar tarea
DELETE /api/tasks/:id          # Eliminar tarea

POST   /api/tasks/:id/subtasks           # A√±adir subtarea
PUT    /api/tasks/:id/subtasks/:subId    # Actualizar subtarea
DELETE /api/tasks/:id/subtasks/:subId    # Eliminar subtarea
```

### üë• Usuarios (`/api/users`)

```
GET /api/users     # Obtener lista de usuarios
GET /api/users/:id # Obtener usuario espec√≠fico
```

---

## ‚öôÔ∏è Middleware

### üîí Middleware de Autenticaci√≥n (auth.ts)

```typescript
const authenticateToken = (req, res, next) => {
  // 1. Extraer token del header Authorization
  const token = req.headers['authorization']?.split(' ')[1];

  // 2. Verificar que existe el token
  if (!token) return res.status(401).json({...});

  // 3. Verificar y decodificar el JWT
  const decoded = jwt.verify(token, JWT_SECRET);

  // 4. A√±adir userId al request
  req.userId = decoded.userId;

  // 5. Continuar al siguiente middleware/controlador
  next();
};
```

**¬øC√≥mo funciona?**

1. Cliente env√≠a token en header: `Authorization: Bearer eyJhbGciOiJIUzI1NiIs...`
2. Middleware extrae el token despu√©s de "Bearer "
3. Verifica la firma del JWT con la clave secreta
4. Si es v√°lido, decodifica y extrae el userId
5. A√±ade userId al objeto request para usar en rutas

---

## ‚úÖ Validaciones

### üîí Validaci√≥n de Subtareas Completas

```typescript
// Middleware pre-save en Task.ts
TaskSchema.pre("save", function (next) {
  if (this.status === "done" && this.subtasks.length > 0) {
    const incompletas = this.subtasks.filter((sub) => !sub.completed);

    if (incompletas.length > 0) {
      return next(new Error(`No se puede completar: ${incompletas.length} subtareas pendientes`));
    }
  }
  next();
});
```

**¬øCu√°ndo se ejecuta?**

- Antes de guardar una tarea (crear o actualizar)
- Antes de actualizaciones con `findOneAndUpdate`
- Autom√°ticamente por Mongoose

### üõ°Ô∏è Validaci√≥n de Permisos

```typescript
// En routes/tasks.ts
if (task.creator.toString() !== userId && task.assignee?.toString() !== userId) {
  return res.status(403).json({
    success: false,
    message: "No autorizado para modificar esta tarea",
  });
}
```

**Reglas de Permisos:**

- ‚úÖ Creador puede: ver, editar, eliminar, gestionar subtareas
- ‚úÖ Asignado puede: ver, editar, gestionar subtareas
- ‚ùå Otros usuarios: solo pueden ver si tienen acceso

---

## üîÑ Flujo de Datos

### Ejemplo: Crear una Tarea

```
1. Cliente POST /api/tasks
   {
     "title": "Implementar login",
     "description": "Crear formulario de login",
     "priority": "high"
   }
   ‚ñº
2. Middleware de autenticaci√≥n
   - Verifica JWT token
   - Extrae userId
   ‚ñº
3. Controlador de tareas
   - Valida datos de entrada
   - Crea objeto Task con userId como creator
   ‚ñº
4. Mongoose/MongoDB
   - Valida seg√∫n esquema
   - Ejecuta middleware pre-save
   - Guarda en base de datos
   ‚ñº
5. Respuesta al cliente
   {
     "success": true,
     "message": "Tarea creada exitosamente",
     "data": { "task": {...} }
   }
```

### Ejemplo: Intentar Completar Tarea con Subtareas Pendientes

```
1. Cliente PUT /api/tasks/123
   { "status": "done" }
   ‚ñº
2. Middleware de autenticaci√≥n ‚úÖ
   ‚ñº
3. Buscar tarea y verificar permisos ‚úÖ
   ‚ñº
4. Intentar actualizar con Mongoose
   ‚ñº
5. Middleware pre-save detecta:
   - status = 'done'
   - subtasks.length > 0
   - Algunas subtareas incompletas
   ‚ñº
6. Error de validaci√≥n ‚ùå
   {
     "success": false,
     "message": "No se puede completar: 2 subtareas pendientes",
     "code": "INCOMPLETE_SUBTASKS"
   }
```

---

## ‚ö†Ô∏è Manejo de Errores

### Tipos de Errores

```typescript
// 1. Errores de Validaci√≥n (400)
{
  success: false,
  message: "No se puede completar: subtareas pendientes",
  code: "INCOMPLETE_SUBTASKS"
}

// 2. Errores de Autenticaci√≥n (401)
{
  success: false,
  message: "Token de acceso requerido"
}

// 3. Errores de Autorizaci√≥n (403)
{
  success: false,
  message: "No autorizado para esta acci√≥n"
}

// 4. Errores de Recurso No Encontrado (404)
{
  success: false,
  message: "Tarea no encontrada"
}

// 5. Errores del Servidor (500)
{
  success: false,
  message: "Error interno del servidor"
}
```

### Middleware Global de Errores

```typescript
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    success: false,
    message: "Algo sali√≥ mal!",
    error: process.env.NODE_ENV === "development" ? err.message : "Error interno",
  });
});
```

---

## üîå Conexi√≥n con MongoDB

### Configuraci√≥n de Conexi√≥n

```typescript
mongoose
  .connect(MONGODB_URI)
  .then(() => console.log("‚úÖ Conectado a MongoDB"))
  .catch((error) => {
    console.error("‚ùå Error de conexi√≥n:", error);
    process.exit(1);
  });
```

### Esquema de Base de Datos

```
taskmanager (Database)
‚îú‚îÄ‚îÄ users (Collection)
‚îÇ   ‚îú‚îÄ‚îÄ { _id, email, password, name, role, createdAt, updatedAt }
‚îÇ   ‚îî‚îÄ‚îÄ { _id, email, password, name, role, createdAt, updatedAt }
‚îú‚îÄ‚îÄ tasks (Collection)
‚îÇ   ‚îú‚îÄ‚îÄ { _id, title, description, status, creator, assignee, subtasks[], ... }
‚îÇ   ‚îî‚îÄ‚îÄ { _id, title, description, status, creator, assignee, subtasks[], ... }
```

---

## üöÄ Ciclo de Vida de una Request

```
1. Cliente hace petici√≥n HTTP
   ‚ñº
2. Express.js recibe la request
   ‚ñº
3. Middleware de CORS, Helmet, Morgan
   ‚ñº
4. Parse de JSON (express.json())
   ‚ñº
5. Routing (/api/tasks, /api/auth, etc.)
   ‚ñº
6. Middleware de autenticaci√≥n (si aplica)
   ‚ñº
7. Controlador de la ruta espec√≠fica
   ‚ñº
8. Interacci√≥n con MongoDB via Mongoose
   ‚ñº
9. Middleware de validaci√≥n (pre/post hooks)
   ‚ñº
10. Respuesta JSON al cliente
```

---

## üîß Comandos de Desarrollo

```bash
# Iniciar servidor en desarrollo
npm run server

# Ver logs de MongoDB
tail -f /opt/homebrew/var/log/mongodb/mongo.log

# Conectar a MongoDB shell
mongo taskmanager

# Ver todas las tareas
db.tasks.find().pretty()

# Ver todos los usuarios
db.users.find().pretty()
```

---

## üìà Pr√≥ximas Mejoras

- [ ] Implementar rate limiting
- [ ] A√±adir logs estructurados
- [ ] Implementar cache con Redis
- [ ] A√±adir tests unitarios
- [ ] Implementar WebSockets para tiempo real
- [ ] A√±adir documentaci√≥n con Swagger
- [ ] Implementar backup autom√°tico

---

Esta arquitectura proporciona una base s√≥lida y escalable para tu aplicaci√≥n de gesti√≥n de tareas. ¬øHay alg√∫n aspecto espec√≠fico que te gustar√≠a que profundice m√°s?

